name: magma-access-gateway
base: core20
version: '1.9.0'
summary: Magma's Access Gateway
description: Magma's Access Gateway is Magma's 4G and 5G core network

grade: devel
confinement: devmode

parts:

  magma-deps:
    plugin: nil
    build-packages:
      - wget
      - software-properties-common
    override-build: |
      set -x
      wget -qO - https://artifactory.magmacore.org:443/artifactory/api/gpg/key/public | apt-key add -
      add-apt-repository 'deb https://artifactory.magmacore.org/artifactory/debian-test focal-ci main'
      add-apt-repository 'deb https://artifactory.magmacore.org/artifactory/debian-test focal-1.7.0 main'
      apt-get update -y
      apt-get install -y bcc-tools libfolly-dev liblfds710 oai-asn1c oai-gnutls oai-nettle oai-freediameter

  bazel:
    plugin: nil
    build-packages:
      - wget
    override-build: |
      set -x
      wget --progress=dot:giga https://github.com/bazelbuild/bazelisk/releases/download/v1.10.0/bazelisk-linux-amd64
      chmod +x bazelisk-linux-amd64
      mv bazelisk-linux-amd64 /usr/sbin/
      ln -f -s /usr/sbin/bazelisk-linux-amd64 /usr/sbin/bazel

  magma-access-gateway:
    plugin: nil
    after:
      - bazel
      - magma-deps
    source: https://github.com/magma/magma
    source-type: git
    build-packages:
      - cmake
      - curl
      - libboost-all-dev
      - libconfig-dev
      - libcurl4-openssl-dev
      - libczmq-dev
      - libdouble-conversion-dev
      - libgoogle-glog-dev
      - libgmp3-dev
      - libmnl-dev=1.0.4-2
      - libpcap-dev=1.9.1-3
      - libsctp-dev
      - libsqlite3-dev
      - libssl-dev
      - libsystemd-dev
      - pkg-config
      - python3-dev
    override-build: |
      set -x
      mkdir -p /workspaces/magma /etc/magma/
      cp -r . /workspaces/magma/
      cp -r lte/gateway/configs /etc/magma/
      ln -f -s /workspaces/magma/.bazel-cache /var/cache/bazel-cache
      ln -f -s /workspaces/magma/.bazel-cache-repo /var/cache/bazel-cache-repo
      
      bazel build //lte/gateway/release:magma_deb_pkg
      ls -a bazel-bin/lte/gateway/release/
